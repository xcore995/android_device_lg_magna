From 216a2f8f30f1a901d0a2bb22b22d044b87153a8d Mon Sep 17 00:00:00 2001
From: xcore995 <arman.p95@gmail.com>
Date: Sun, 31 May 2020 13:58:06 +0000
Subject: [PATCH 2/2] Restore earlysuspend

Change-Id: I753434579d037ca335f277263ebef4ff97a0872d
---
 libsuspend/Android.bp        |  1 +
 libsuspend/autosuspend.c     | 12 +++++++++++-
 libsuspend/autosuspend_ops.h |  1 +
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/libsuspend/Android.bp b/libsuspend/Android.bp
index b3e36c2bd..f7c631088 100644
--- a/libsuspend/Android.bp
+++ b/libsuspend/Android.bp
@@ -9,6 +9,7 @@ cc_library {
 
     srcs: [
         "autosuspend.c",
+        "autosuspend_earlysuspend.cpp",
         "autosuspend_wakeup_count.cpp",
     ],
     export_include_dirs: ["include"],
diff --git a/libsuspend/autosuspend.c b/libsuspend/autosuspend.c
index b87f59cd6..607025c3c 100644
--- a/libsuspend/autosuspend.c
+++ b/libsuspend/autosuspend.c
@@ -32,12 +32,22 @@ static int autosuspend_init(void) {
         return 0;
     }
 
+    autosuspend_ops = autosuspend_earlysuspend_init();
+    if (autosuspend_ops) {
+        goto out;
+    }
+
     autosuspend_ops = autosuspend_wakeup_count_init();
-    if (autosuspend_ops == NULL) {
+    if (autosuspend_ops) {
+        goto out;
+    }
+
+    if (!autosuspend_ops) {
         ALOGE("failed to initialize autosuspend");
         return -1;
     }
 
+out:
     ALOGV("autosuspend initialized");
     return 0;
 }
diff --git a/libsuspend/autosuspend_ops.h b/libsuspend/autosuspend_ops.h
index b0024c8bb..a21f20792 100644
--- a/libsuspend/autosuspend_ops.h
+++ b/libsuspend/autosuspend_ops.h
@@ -25,6 +25,7 @@ struct autosuspend_ops {
 };
 
 __BEGIN_DECLS
+struct autosuspend_ops *autosuspend_earlysuspend_init(void);
 struct autosuspend_ops *autosuspend_wakeup_count_init(void);
 __END_DECLS
 
-- 
2.25.1

